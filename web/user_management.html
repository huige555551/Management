<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
<head>
    <meta charset="utf-8">
    <title>用户管理</title>
    <link rel="stylesheet" href="css/html.css">
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/bootstrap3-editable/css/bootstrap-editable.css">
    <link rel="stylesheet" href="assets/bootstrap-table/bootstrap-table.css">
    <link rel="stylesheet" href="assets/bootstrap-select/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="assets/bootstrap-validator/css/bootstrapValidator.min.css">
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="assets/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
    <script src="assets/bootstrap-table/extensions/editable/bootstrap-table-editable.min.js"></script>
    <script src="assets/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="assets/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="assets/bootstrap-select/js/i18n/defaults-zh_CN.min.js"></script>
    <script src="assets/bootstrap-validator/js/bootstrapValidator.min.js"></script>
    <script>
        $(document).ready(function(){
            initTable();
            vadidateModal();
            $('#search_text').keydown(function (e) {
                if (e.keyCode === 13) {
                    $('#search_btn').click();
                }
            });
        });
        function addUser() {
            $('#add_user_form').data('bootstrapValidator').validate();
            if(!$('#add_user_form').data('bootstrapValidator').isValid()){
                return ;
            }
            $('#add_modal').modal('hide');
            var user_phone = $('#add_user_phone').val();
            var user_name = $('#add_user_name').val();
            var id = $('#add_id').val();
            var user_pwd = $('#add_user_pwd').val();
            var balance = $('#add_balance').val();
            var deposit = $('#add_deposit').val();
            var score = $('#add_score').val();
            var state = $('#add_state').val();
            var data = {
                "user_phone": user_phone,
                "user_name": user_name,
                "id": id,
                "user_pwd": user_pwd,
                "balance": balance,
                "deposit": deposit,
                "score": score,
                "state": state
            };
            $.ajax({
                type: "post",
                url: "addUserServlet",
                data: data,
                dataType: "json",
                async: false,
                success: function(json) {
                    if(parseInt(json.code) === 1) {
                        alert("添加失败！");
                    }
                    else {
                        alert("添加成功！");
                    }
                }
            });
            $('#user_info').bootstrapTable('append', data);
            resetModal();
        }
        function searchUser() {
            var user_phone = $("#search_text").val();
            var data = {
                "user_phone": user_phone
            };
            $.ajax({
                type: "post",
                url: "searchUserServlet",
                data: data,
                dataType: "json",
                success: function(json){
                    $('#user_info').bootstrapTable('load', json);
                }
            });
            $('#search_text').val('');
        }
        function deleteUser(b) {
            var tr = b.parentNode.parentNode;
            var user_phone = tr.getElementsByClassName("user_phone")[0].textContent;
            var data = {
                "user_phone": user_phone
            };
            $.ajax({
                type: "post",
                url: "deleteUserServlet",
                data: data,
                dataType: "json",
                success: function(json){
                    if(parseInt(json.code) === 1) {
                        alert("删除失败！");
                    }
                    else {
                        alert("删除成功！");
                        tr.remove();
                    }
                }
            });
        }
        function initTable() {
            $('#user_info').bootstrapTable('destroy');
            $("#user_info").bootstrapTable({
                //使用post请求到服务器获取数据
                method: "post",
                //获取数据的Servlet地址
                url: "userServlet",
                //表格显示条纹
                striped: true,
                //启动分页
                pagination: true,
                //每页显示的记录数
                pageSize: 20,
                //当前第几页
                pageNumber:1,
                //记录数可选列表
                pageList: [10, 15, 20, 25, 30],
                //是否启用查询
                search: false,
                //显示下拉框勾选要显示的列
                showColumns: true,
                //显示刷新按钮
                showRefresh: true,
                //设置是由客户端分页还是由服务端分页
                sidePagination: "client",
                columns: [{
                    field: 'user_phone',
                    title: '用户手机号',
                    sortable: true
                }, {
                    field: 'user_name',
                    title: '用户昵称',
                    type: 'text',
                    disabled: false,
                    editable: {
                        title: '输入用户昵称',
                        type: 'text',
                        validate: function(v) {
                            if (!v) {
                                return '用户昵称不能为空';
                            }
                        }
                    }
                }, {
                    field: 'id',
                    title: '用户身份证号码',
                    sortable: true,
                    editable: {
                        title: '输入用户身份证号码',
                        type: 'text',
                        validate: function(v) {
                            if (v.length !== 18) {
                                return '用户身份证号码需满18位';
                            }
                        }
                    }
                }, {
                    field: 'user_pwd',
                    title: '用户密码',
                    editable: {
                        title: '输入用户密码',
                        type: 'text',
                        validate: function(v) {
                            if (!v) {
                                return '用户密码不能为空';
                            }
                            else if (v.length < 10 && v.length > 18) {
                                return '用户密码需在10位与18位之间';
                            }
                        }
                    }
                }, {
                    field: 'deposit',
                    title: '用户押金',
                    editable: {
                        title: '输入用户押金',
                        type: 'text',
                        validate: function(v) {
                            if (isNaN(v)) {
                                return '用户押金必须是数字';
                            }
                            else if (parseInt(v) <= 0) {
                                return "用户押金不能小于0";
                            }
                        }
                    }
                }, {
                    field: 'balance',
                    title: '用户余额',
                    editable: {
                        title: '输入用户余额',
                        type: 'text',
                        validate: function(v) {
                            if (isNaN(v)) {
                                return '用户余额必须是数字';
                            }
                            else if (parseInt(v) <= 0) {
                                return "用户余额不能小于0";
                            }
                        }
                    }
                }, {
                    field: 'score',
                    title: '用户积分',
                    editable: {
                        title: '输入用户积分',
                        type: 'text',
                        validate: function(v) {
                            if (isNaN(v)) {
                                return '用户积分必须是数字';
                            }
                        }
                    }
                }, {
                    field: 'state',
                    title: '用户认证状态',
                    editable: {
                        type: 'select',
                        title: '选择用户认证状态',
                        source: [{
                            value: 0,
                            text: '未认证'
                        }, {
                            value: 1,
                            text: '已认证'
                        }]
                    }
                }],
                onEditableSave: function(field, row) {
                    console.log(row);
                    var data = {
                        "user_phone": row.user_phone,
                        "user_name": row.user_name,
                        "user_pwd": row.user_pwd,
                        "id": row.id,
                        "state": row.state,
                        "balance": row.balance,
                        "deposit": row.deposit,
                        "score": row.score
                    };
                    $.ajax({
                        type: "post",
                        url: "updateUserServlet",
                        data: data,
                        dataType: "json",
                        async: false,
                        success: function(json) {
                            if(parseInt(json.code) === 1) {
                                alert("更改失败！");
                            }
                            else {
                                alert("更改成功！");
                            }
                        }
                    });
                }
            });
        }
        function vadidateModal() {
            $('#add_user_form').bootstrapValidator({
                feedbackIcons: {
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    user_phone: {
                        validators: {
                            notEmpty: {
                                message: '用户手机号不能为空'
                            },
                            stringLength: {
                                min: 11,
                                max: 11,
                                message: '用户手机号必须为11位'
                            },
                            regexp: {
                                regexp: /^[0-9]+$/,
                                message: '用户手机号必须都为数字'
                            }
                        }
                    },
                    user_name: {
                        validators: {
                            notEmpty: {
                                message: '用户昵称不能为空'
                            }
                        }
                    },
                    id: {
                        validators: {
                            stringLength: {
                                min: 18,
                                max: 18,
                                message: '身份证号必须为18位'
                            },
                            regexp: {
                                regexp: /^[0-9xX]+$/,
                                message: '身份证格式不符'
                            }
                        }
                    },
                    user_pwd: {
                        validators: {
                            notEmpty: {
                                message: '用户密码不能为空'
                            },
                            stringLength: {
                                min: 6,
                                max: 18,
                                message: '用户密码必须在6至18位之间'
                            }
                        }
                    },
                    deposit: {
                        validators: {
                            notEmpty: {
                                message: '押金不能为空'
                            },
                            regexp: {
                                regexp: /^[0-9]+$/,
                                message: '押金必须为非负数'
                            }
                        }
                    },
                    balance: {
                        validators: {
                            notEmpty: {
                                message: '余额不能为空'
                            }
                        }
                    },
                    score: {
                        validators: {
                            notEmpty: {
                                message: '积分不能为空'
                            }
                        }
                    }
                }
            });
        }
        function resetModal() {
            //虽然选择项确实改变了，但是文本提示内容还是不变，不知为何
            $('#add_state').selectedIndex = 0;
            $('#add_user_form').find('input').val('');
            $('#add_user_form').data('bootstrapValidator').destroy();
            $('#add_user_form').data('bootstrapValidator', null);
            vadidateModal();
        }
    </script>
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container navbar-left">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">“快租车”后台管理</a>
            </div>
            <div>
                <ul class="nav navbar-nav">
                    <li class="active">
                        <a href="#">用户管理</a>
                    </li>
                    <li>
                        <a href="car_management.html">车辆管理</a>
                    </li>
                    <li>
                        <a href="car_type_management.html">车辆类型管理</a>
                    </li>
                    <li>
                        <a href="shop_management.html">服务点管理</a>
                    </li>
                    <li>
                        <a href="order_management.html">订单管理</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="page-wrapper">
        <div class="container">
            <div align="center" class="infoDiv"></div>
            <div id="toolbar">
                <!--如果这里是表单的话，设置文本框监听回车键再按下回车键时会导致页面刷新-->
                <input type="text" id="search_text" class="form-control" placeholder="请输入用户手机号" style="float: left;">
                <input type="button" id="search_btn" class="btn btn-default" style="float: left; position: absolute;" value="搜索" onclick="searchUser()">
                <!--这里找不到好的方法可以试三个 input 处于同一行，只能通过 margin 来变通-->
                <input type="button" class="btn btn-primary" data-toggle="modal" data-target="#add_modal" style="float: left; position:absolute; margin-left: 60px" value="添加用户">
            </div>
            <div class="modal fade" id="add_modal" role="dialog" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true" onclick="resetModal()">&times;</button>
                            <h4 class="modal-title" id="myModalLabel">添加用户</h4>
                        </div>
                        <div id="add_user_form">
                            <div class="form-horizontal modal-body">
                                <div class="form-group">
                                    <label for="add_user_phone" class="col-sm-3 control-label">用户手机号</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_user_phone" name="user_phone" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_user_name" class="col-sm-3 control-label">用户昵称</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_user_name" name="user_name" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_id" class="col-sm-3 control-label">用户身份证号</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_id" name="id" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_user_pwd" class="col-sm-3 control-label">用户密码</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_user_pwd" name="user_pwd" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_deposit" class="col-sm-3 control-label">用户押金</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_deposit" name="deposit" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_balance" class="col-sm-3 control-label">用户余额</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_balance" name="balance" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_score" class="col-sm-3 control-label">用户积分</label>
                                    <div class="col-sm-7">
                                        <input type="text" id="add_score" name="score" class="form-control">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="add_state" class="col-sm-3 control-label">用户认证状态</label>
                                    <div class="col-sm-7">
                                        <select id="add_state" class="selectpicker show-tick form-control" data-live-search="true">
                                            <option value="0" class="selected">未认证</option>
                                            <option value="1">已认证</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-default" data-dismiss="modal" onclick="resetModal()">取消</button>
                                <button class="btn btn-primary" onclick="addUser()">确认添加</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <table id="user_info" class="table table-bordered tab-content" data-toolbar="#toolbar"></table>
        </div>
    </div>
</body>
</html>
